<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">IP Multicasting</h1><p class="page-description">Broadcasting content over IP Networks</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2015-03-31T00:00:00-05:00" itemprop="datePublished">
        Mar 31, 2015
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      11 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#networking">networking</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This article tries to synthetise a few RFCs about Multicasting over IPv4.</p>

<p>Services such as TV and radio were initially designed to be broadcasted over hertzian media for which broadcasting is the standard way of communicating. 
But these services among many others had to transition to the IP world to follow and widen their audience.</p>

<p>Until here, no problem. Except with IP, broadcast services are no longer alone and they have to live along many many others.
Most of which are unicast services.</p>

<p>The IP protocol, as specified in <a href="https://tools.ietf.org/html/rfc791">RFC 791</a>, allowed one to one (unicast) and one to everyone (broadcast) only.
Simply broadcasting the traffic is not an option as it would flood every network worldwide (or more likely be blocked at the first router encountered).
Which leaves us with sending traffic to each client requesting the service in unicast mode.</p>

<p>This becomes expensive bandwidth and energy wise for the broadcast source and for the network in general after only a few clients as the content is duplicated on many segments of the network.
Reducing data duplication and optimizing network ressources while also extending the reach of the broadcasting service are the main objectives of IP Multicasting.</p>

<p>To better understand what is at stake with IP multicast, we can look at the figures below. 
In the case of legacy broadcasting over a dedicated network, a broadcasting point has to be deployed close to each client while with IP multicast, only the very necessary flows are generated over an already deployed network.</p>

<p><a href="http://couble.ovh/figures/broadcast-case.png"><img src="./IP Multicasting - Notebook_files/broadcast-case.png" alt="Case of broadcasted content over Hertzian media" /></a>Figure 1: Case of broadcasted content over Hertzian media [<a href="http://couble.ovh/figures/broadcast-case.png">PNG</a>]
<a href="http://couble.ovh/figures/multicast-case.png"><img src="./IP Multicasting - Notebook_files/multicast-case.png" alt="Case of multicasted content over IP networks" /></a>Figure 2: Case of multicasted content over IP networks [<a href="http://couble.ovh/figures/multicast-case.png">PNG</a>]</p>
<h3 id="multicast-group-management-in-ipv4">Multicast group management in IPv4</h3>

<p>In 1989, the IETF published the informational <a href="https://www.ietf.org/rfc/rfc1112.txt">RFC 1112</a> to gather recommendations on how to implement IP Multicast inside the IP stack implementations.
It also defines in the appendices the protocol IGMP. IGMP has been updated twice in 1997 (IGMPv2) and 2006 (IGMPv3).</p>

<h4 id="integration-in-the-ip-stack">Integration in the IP stack</h4>

<p>IGMP is a part of IP, in the same way ICMP is.
IGMP only introduces a few additional services offered to the transport layer and requires an adapted Data Link layer for Multicast.
Initially, all an IP host/router has to do to be multicast compliant, is to accept and process packets destined to multicast groups if it belongs to the group, know which groups it belongs to and of course the ability to join/leave a group.</p>

<p><a href="http://couble.ovh/figures/IGMP_stack.png"><img src="./IP Multicasting - Notebook_files/IGMP_stack.png" alt="IGMP integration in IP stack, extracted from RFC 1112" /></a>Figure 3: IGMP integration in IP stack, extracted from RFC 1112 [<a href="http://couble.ovh/figures/IGMP_stack.png">PNG</a>]</p>
<h5 id="multicast-ip-addresses">Multicast IP addresses</h5>

<p>The IANA has reserved the <code class="language-plaintext highlighter-rouge">224.0.0.0/4</code> for multicast group addresses. See <a href="http://tools.ietf.org/html/rfc5771">RFC 5771</a> for more details and best practices about IPv4 multicast addresses.</p>

<p>Many of the (2^{28}) addresses are reserved, 
As an example, the <code class="language-plaintext highlighter-rouge">224.0.0.0/23</code> is reserved for network protocols (local &amp; internetworks), here are a few noticeable addresses:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">224.0.0.1</code>: All hosts multicast group address.</li>
  <li><code class="language-plaintext highlighter-rouge">224.0.0.2</code>: All routers multicast group address.</li>
  <li><code class="language-plaintext highlighter-rouge">224.0.0.13</code>: multicast group address used by PIMv2</li>
  <li><code class="language-plaintext highlighter-rouge">224.0.0.22</code>: multicast group address used by IGMPv3.</li>
</ul>

<p>A few other addresses are reserved for router redundancy/routing protocols, as the <code class="language-plaintext highlighter-rouge">224.0.0.18</code> group address which is reserved for VRRP, and <code class="language-plaintext highlighter-rouge">224.0.0.5-6</code> reserved for OSPF.</p>

<p>More generally, the IANA has divided the multicast IPv4 block into blocks, each one being destined to a specific usage.
Among these groups, we can find:</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">233.0.0.0/8</code> block is the GLOP Block, with (2^{16}) /24 blocks assigned to each 16bits ASN.</li>
  <li>The <code class="language-plaintext highlighter-rouge">239.0.0.0/8</code> block for private use (equivalent in multicast of the <code class="language-plaintext highlighter-rouge">10.0.0.0/8</code> block for unicast).</li>
</ul>

<h5 id="l2-muliticast-addresses">L2 muliticast addresses</h5>

<p>IP multicasting requires an adaptation of layers underneath IP. Here we’ll only deal with Ethernet.</p>

<p>Ethernet has defined an OUI specific for Ethernet multicast addresses: <code class="language-plaintext highlighter-rouge">01-00-5E</code> (hex).
IP multicast addresses are then translated into the corresponding MAC addresses with a simple principle, copying the 23 lowest-order bits from the IP address into the 23 lowest-order bits of the MAC address.</p>

<p><a href="http://couble.ovh/figures/ipm-mac-translation.png"><img src="./IP Multicasting - Notebook_files/ipm-mac-translation.png" alt="IP multicast address translation into MAC multicast address." /></a>Figure 4: IP multicast address translation into MAC multicast address. [<a href="http://couble.ovh/figures/ipm-mac-translation.png">PNG</a>]
(Credits: <a href="http://www.tcpipguide.com/free/t_TCPIPAddressResolutionForIPMulticastAddresses.htm">The TCP IP guide</a>)</p>
<h4 id="evolution-of-igmp">Evolution of IGMP</h4>

<p>IGMP is the protocol that enables hosts to inform routers what group they belong to, and routers to ask hosts on the LAN for this information.
The protocol reach is local, and an IGMP packets are never routed.
Besides, IGMP messages are carried within IP packets.</p>

<p>IGMP defines two types of actors:</p>

<ul>
  <li><em>Hosts</em>: the end users in a LAN who join and leave multicast groups.</li>
  <li><em>Routers</em>: the IP routers who coordinate the multicast groups in a LAN. In IGMPv2 &amp; IGMPv3, routers are diffentiated according to their IGMP role.
    <ul>
      <li>The <em>Querier</em> is the active IGMP routers on the LAN. He is the one to ask for membership reports.</li>
      <li>The <em>Non-Queriers</em> are other routers on the LAN, implementing IGMP but not performing any IGMP action. 
   They must be IGMP silent.</li>
    </ul>
  </li>
</ul>

<h5 id="igmpv1">IGMPv1</h5>

<p>IGMPv1 only describes how host advertise the groups they belong to, and how routers poll request host to report their memberships.</p>

<p>In IGMPv1, the IGMP router sends a <em>Query</em> to the <strong>All Host</strong> multicast group address (<code class="language-plaintext highlighter-rouge">224.0.0.1</code>) to know what are the multicast groups needed on the LAN.
Hosts, when recieving these queries, respond by sending a group report for each group they belong to.</p>

<p>The relevant information for the router is which groups are required on the LAN, but not how many clients there is.
Hence, in order to reduce the amount of IGMP packets flowing on the LAN right after a <em>Query</em>, hosts must set up a timer for each multicast group and send each report when its timer expires, if no other reports has been recieved for the group.</p>

<p>The IGMPv1 frame is quite simple and forecast future IGMP versions with additional data fields and packet types.</p>

<p><a href="http://couble.ovh/figures/igmpv1_frame.png"><img src="./IP Multicasting - Notebook_files/igmpv1_frame.png" alt="IGMPv1 Frame format, extracted from RFC1112" /></a>Figure 5: IGMPv1 Frame format, extracted from RFC1112 [<a href="http://couble.ovh/figures/igmpv1_frame.png">PNG</a>]</p>
<h5 id="igmpv2">IGMPv2</h5>

<p>Version 2 of the protocol improves IGMPv1 by enabling hosts to tell when they leave a group, allowing faster multicast stream closure and a more efficient use of bandwidth globally.</p>

<p>The IGMP frame is modified in version 2, with a max-response-time field to allow router to constrol and speed up the process of retrieving a report from a host.
Routers keep sending periodical <em>General Queries</em> to have a group membership overview for a LAN.</p>

<p>This version of the group management protocol requires hosts to send an IGMP <em>Leave Group</em> message whenever the <em>leave_group</em> service is asked to the IP/IGMPv2 stack.
This message is sent to the <strong>All Router</strong> multicast group address with a new packet type.</p>

<p>When recieving a group leave report from a host, routers must perform a <em>Group Specific Query</em> to the <code class="language-plaintext highlighter-rouge">x.x.x.x</code> to check if there is at least one host belonging to the <code class="language-plaintext highlighter-rouge">x.x.x.x</code> multicast group.</p>

<p><a href="http://couble.ovh/figures/igmpv2_frame.png"><img src="./IP Multicasting - Notebook_files/igmpv2_frame.png" alt="IGMPv2 Frame format, extracted from RFC2236" /></a>Figure 6: IGMPv2 Frame format, extracted from RFC2236 [<a href="http://couble.ovh/figures/igmpv2_frame.png">PNG</a>]</p>
<h5 id="igmp-snooping-switches">IGMP Snooping Switches</h5>

<p>IGMP describles the control plane of multicast communications.
On the data plane side, over a LAN, switches simply broadcast multicast frames by default.
Over large LANs, it becomes very inefficient in terms of bandwidth usage.</p>

<p><a href="http://couble.ovh/figures/multicast-snoopingimpact.png"><img src="./IP Multicasting - Notebook_files/multicast-snoopingimpact.png" alt="Impact of snooping switches on a LAN" /></a>Figure 7: Impact of snooping switches on a LAN [<a href="http://couble.ovh/figures/multicast-snoopingimpact.png">PNG</a>]</p>

<p>Manufacturers such as Cisco quickly developped software to allow user to configure switches to only forward multicast frames to the ports where multicast reports were recieved for that specific group.
Of course the the <strong>All Host</strong> multicast group ethernet address (<code class="language-plaintext highlighter-rouge">01-00-5E-00-00-01</code>) should always be broadcasted.</p>

<p>Implementations are highly manufacturer dependant, even after the IETF produced the <em>Best Practice</em> <a href="https://tools.ietf.org/html/rfc4541">RFC4541</a> in 2006.</p>

<p>This mechanism reduces considerably the bandwidth used in a LAN by multicast traffic, and extends the multicast principles to the LAN.</p>

<p><a href="http://couble.ovh/figures/multicast-snoopingdetail.png"><img src="./IP Multicasting - Notebook_files/multicast-snoopingdetail.png" alt="How snooping switches handle multicast" /></a>Figure 8: How snooping switches handle multicast [<a href="http://couble.ovh/figures/multicast-snoopingdetail.png">PNG</a>]</p>

<p>Snooping switches should always broadcast a multicast frame intended for a multicast group where no report has been sent. <strong>But</strong>, it is not always implemented.
A common issue with IGMP snooping is that routing protocols using multicast address to communicate between routers are blocked by the snooping switch.</p>

<p>Also, IGMP snooping doesn’t live well with some IGMPv1 and IGMPv2, where hosts may assume that the traffic is broadcasted and not see any interest in sending a report if another host has sent one earlier.
As a matter of fact, RFC1112 recommends that a host cancels its report-send-timer uppon reception of a report for the same multicast group.
The snooping switch, on the other end will never see a multicast frame originating from the host for that group and will not forward multicast frames towards the unfortunate host.</p>

<p>Along the IGMP snooping best practices, the IETF published a Standard Track, RFC3376 for the IGMPv3 specification, snooping aware.</p>

<h5 id="igmpv3">IGMPv3</h5>

<p>IGMPv3 was specified with a few flaws of the previous versions or improvements in mind:</p>

<ul>
  <li>Snooping switches as discussed above.</li>
  <li>Hosts would often need the traffic from one source rather than the whole multicast group traffic.</li>
</ul>

<p>For example, an IPTV service could use one multicast group to broadcast all its channels, but a client of this service only needs one source’s stream at a time.</p>
<ul>
  <li>Host suppression (cancelling sending a membership report because another host already has), doesn’t allow a clear host identification by routers</li>
</ul>

<h6 id="frame-format">Frame format</h6>

<p>IGMPv3 use a larger frame for its messages, and uses two different formats for <em>Membership Queries</em> and <em>Membership Reports</em>.
A few other additional fields have been added in IGMPv3 to better control multicast group members and optimize multicast flows.</p>

<p>One of the main changes is that this version allows host to aggregate their group reports inside one.
But then the report has to be sent to a generic multicast address, <code class="language-plaintext highlighter-rouge">224.0.0.22</code> dedicated to IGMPv3.
All IGMPv3 router must belong to this group as <em>Hosts</em>.</p>

<p><em>Membership Query</em> messages are now always group specific and include a list of available multicast sources for that group.</p>

<p><a href="http://couble.ovh/figures/igmpv3_frame.png"><img src="./IP Multicasting - Notebook_files/igmpv3_frame.png" alt="IGMPv3 frame format, as specified in RFC3376" /></a>Figure 9: IGMPv3 frame format, as specified in RFC3376 [<a href="http://couble.ovh/figures/igmpv3_frame.png">PNG</a>]</p>
<h6 id="source-specific-multicast">Source specific multicast</h6>

<p>As multicast sources are provided to every IGMPv3 host, they are able to choose and tell routers which sources they want to listen to.</p>

<p>This allows a more precise traffic engineering over WANs (only sources which have clients will be multicasted, and only to those interested).
I think this change was introduced because there is only so many multicast addresses for each operator compared to the amount of services that can benefit from multicast.
Source specific multicast allows a company/operator to “broadcast” (used here to say “make a content available to everyone”) multiple services over a unique IP.</p>

<p>Suscribers usage can then be traced more precisely inside the multicast group, and the audience can easilly be measured for each service individually.</p>

<h6 id="snooping-awareness">Snooping awareness</h6>

<p>With source specific multicast, two hosts requesting membership of the same multicast group may not ask for the same sources.
Hence a lot of mecanisms such as host suppression are not relevant or necessary anymore.
Moreover removing host suppression solves all snooping problems encountered in v1 or v2.</p>

<h6 id="source-inclusionexclusion">Source inclusion/exclusion</h6>

<p>There are two types of reports:</p>

<ul>
  <li>Inclusive reports (with a <em>Group Record</em> field set to 1 aka MODE_IS_INCLUDE), only ask for a limited number of sources.</li>
  <li>Exlusive reports (with a <em>Group Record</em> field set to 2 aka MODE_IS_EXCLUDE), ask for all sources except a limited number of sources</li>
</ul>

<p>This provides more flexibility to hosts, while also factorizing the join and leave actions into one single message.</p>

<p>For example the join group report from IGMPv1/v2 is a MODE_IS_EXCLUDE report with no source specified, and the leave group report is a MODE_IS_INCLUDE report with no source specified.</p>

<h4 id="interoperability-of-different-versions-of-igmp">Interoperability of different versions of IGMP</h4>

<p>Each version of IGMP is specified to be retro-compatible, but are known to get along with each other very badly.
Generally, if the later version (v2/v3) detects an IGMP router with an earlier (v1/v2) version it automatically switches to the oldest version of the two.</p>

<p>Nevertheless, IGMPv3 can theoretically function with IGMPv1/v2 hosts in the LAN.</p>

<h3 id="multicasting-inside-a-lan">Multicasting inside a LAN</h3>

<p>IP Multicast is mainly designed for the transport and routing of multicast over networks.
But even in a LAN, it can find some useful applications.</p>

<p>Multicasting over solely a LAN provides some challenges aswell and I will try to overview some theoretical possibilities in a later article dedicated to the topic.</p>

<p><strong>However in the meantime, I remain open to any feedback or advises on architectures, specifications or products you may know. So don’t hesitate to leave me a comment below!</strong></p>

<h3 id="multicast-routing">Multicast routing</h3>

<p>Routing multicast traffic basically consist in building the shortest tree to cover all suscribers for a service.</p>

<p>Multicast routing is another vast subject that I am not able to study and syntethize immediately, so it will hopefully be addressed in a future article.</p>

<p>Sources:</p>

<ol>
  <li><a href="https://www.ietf.org/rfc/rfc1112.txt">RFC 1112: Host Extension for IP Multicasting</a></li>
  <li><a href="https://www.ietf.org/rfc/rfc2236.txt">RFC 2236: Internet Group Management Protocol, Version 2</a></li>
  <li><a href="https://tools.ietf.org/html/rfc3376">RFC 3376: Internet Group Management Protocol, Version 3</a></li>
  <li><a href="http://tools.ietf.org/html/rfc5771">RFC 5771: IANA Guidelines for IPv4 Multicast Address Assignments</a></li>
  <li><a href="https://www.ietf.org/rfc/rfc4541.txt">RFC 4541: Considerations for Internet Group Management Protocol (IGMP) and Multicast Listener Discovery (MLD) Snooping Switches</a></li>
  <li><a href="http://fr.wikipedia.org/wiki/Protocol_Independent_Multicast">Wikipedia article on PIM routing</a></li>
</ol>


  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ycouble/til"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/networking/2015/03/31/ip-multicast.html" hidden></a>
</article>
