<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Dynamic Firewalling | yco-til</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Dynamic Firewalling" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Securing Multimedia Dynamic Protocols" />
<meta property="og:description" content="Securing Multimedia Dynamic Protocols" />
<link rel="canonical" href="https://ycouble.github.io/til/security/2015/04/27/dyn-firewall.html" />
<meta property="og:url" content="https://ycouble.github.io/til/security/2015/04/27/dyn-firewall.html" />
<meta property="og:site_name" content="yco-til" />
<meta property="og:image" content="https://ycouble.github.io/til/images/blog/protect.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-04-27T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://ycouble.github.io/til/images/blog/protect.jpg" />
<meta property="twitter:title" content="Dynamic Firewalling" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2015-04-27T00:00:00-05:00","datePublished":"2015-04-27T00:00:00-05:00","description":"Securing Multimedia Dynamic Protocols","headline":"Dynamic Firewalling","image":"https://ycouble.github.io/til/images/blog/protect.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://ycouble.github.io/til/security/2015/04/27/dyn-firewall.html"},"url":"https://ycouble.github.io/til/security/2015/04/27/dyn-firewall.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/til/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://ycouble.github.io/til/feed.xml" title="yco-til" /><link rel="shortcut icon" type="image/x-icon" href="/til/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/til/">yco-til</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/til/about/">About Me</a><a class="page-link" href="/til/search/">Search</a><a class="page-link" href="/til/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Dynamic Firewalling</h1><p class="page-description">Securing Multimedia Dynamic Protocols</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2015-04-27T00:00:00-05:00" itemprop="datePublished">
        Apr 27, 2015
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/til/categories/#security">security</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>With the now very common Triple Play, Voice over IP and Video Streaming applications are widely deployed and used. And as many events reminded us, securing applications is a critical matter nowadays.</p>

<p>However, deploying firewalling solutions when VoIP or Streaming applications are present on the network can be very risky as it is very hard for the network administrator to have feedback on the user experience.
In this article, we’ll try to sum up a few important points on how to support VoIP and Streaming applications passing through a firewall.</p>

<h3 id="context--available-solutions">Context &amp; available Solutions</h3>

<p>VoIP services often use the Session Initiation Protocol (SIP, specified in RFC 3261 &amp; RFC 3265), the other protocols (MGCP, H323 and others) are still used but are progressively less used by end-users.</p>

<p>Streaming and videoconference services on the other may use SIP, RTSP, or even HTTP to set up their media sessions. We will focus here on SIP, but the remarks here are also applicable to other protocols.</p>

<h4 id="dynamic-protocols">Dynamic protocols</h4>

<p>VoIP and Streaming are seen as dynamic protocol because the media payload is often sent on a different channel than the session information. 
This is inherited from Legacy telephony with separated control and data planes.</p>

<p>It generally looks like this:</p>

<p><a href="http://couble.ovh/figures/dynamic_protocol.png"><img src="./Dynamic Firewalling - Notebook_files/dynamic_protocol.png" alt="Media session setup" /></a>Figure 1: Media session setup [<a href="http://couble.ovh/figures/dynamic_protocol.png">PNG</a>]</p>
<h4 id="sip">SIP</h4>

<p>SIP is a dynamic protocol, where one or more sessions are negotiated by two user-agents before starting to send the user data (here, voice of video).</p>

<p>A classical SIP conversation between two direct agents will look like this:</p>

<p><a href="http://couble.ovh/figures/SIP_session.png"><img src="./Dynamic Firewalling - Notebook_files/SIP_session.png" alt="Simple SIP conversation" /></a>Figure 2: Simple SIP conversation [<a href="http://couble.ovh/figures/SIP_session.png">PNG</a>]</p>

<p>SIP generally relies on the Session Description Protocol -which is more a language to describe a media session than a protocol- to negotiate the parameters of the session.</p>

<p>SDP is carried in some SIP packets (e.g. INVITEs, 200 OKs, ACKs), and provides information such as UDP ports which will be used to send/receive the media content.</p>

<h4 id="allowing-sip-and-its-content-through-a-firewall">Allowing SIP and its content through a firewall</h4>

<p>On a firewall, allowing VoIP will first require the admin to authorize the SIP protocol, which classically uses UDP port 5060 both ways.</p>

<p>But then, how do we, as the admin, allow the voice/video flows?</p>

<ul>
  <li>A simple solution is to authorize a window of UDP ports that we know will be assigned to the media flows.</li>
</ul>

<p>These ports are generally assigned within configurable limits and asking the person in charge of the VoIP solution may be sufficient to make it work.
 But this solution does not satisfy high security requirements as thousands of ports are potentially open and uncontrolled.</p>
<ul>
  <li>A more complex solution is to implement statefulness in the firewall, and by inspecting the SIP/SDP payload, to identify “on the fly” which ports need to be open and to open them only for the duration of the call.</li>
</ul>

<h3 id="consequences-of-dynamic-firewalling">Consequences of dynamic firewalling</h3>

<h4 id="hardware">Hardware</h4>

<p>This type of operation requires to have Deep Inspection capacities, and enough resource to save and maintain a state table of each session. 
In other words, a big CPU and enough RAM, as well as a full implementation of every dynamic protocol.</p>

<p>And therefore higher end firewalls, obviously.</p>

<h4 id="impact-on-other-functions">Impact on other functions</h4>

<p>On next generation firewalls, other functions such as IPS (Intrusion Protection System), Application control, DoS prevention may be activated on dynamic protocol flows, and must be adapted to support the media flow.</p>

<p>For example, the application control, which is in charge to check the authenticity of the application headers of a packet, will need to be aware that a new type of payload needs to be authorized.</p>

<h4 id="dos-protection">DoS Protection</h4>

<p>With dynamic firewalling, it is possible to dynamically identify which flows are legitimate media flows and which ones may be malicious ones. 
Thus, it enables the admin to apply different policies to identified media sessions and other generic unknown packets.</p>

<p>Also, by isolating media session flows in a dedicated DoS policy, one may ensure that none of these packets are impacted by a global DoS attack (udp flood for example)</p>

<h4 id="stateful-firewall-clusters">Stateful firewall clusters</h4>

<p>When the firewall is redundant/load-balanced, what happens when the master firewall fails?</p>

<p>With the simple solution, both firewalls have the same simple configuration and media streams are not interrupted.
But when dynamic management of sessions is implemented and configured, it is a bit more complicated.</p>

<p>All sessions must be synchronized between the firewall who initiated the session and the other firewalls, so that when it fails, the firewall which will inherit of the session knows which ports must be open for the media streams.
This is a pretty important feature to be developped when dynamic session management is used, or the service user experience may be seriously degraded in case of a failure (all calls/media streams interrupted at once).</p>

<h3 id="example-on-fortios">Example on FortiOS</h3>

<p>Let’s have a look at how it is implemented in FortiOS, the firewall OS for Fortinet products (Fortigate series).</p>

<h4 id="service-configuration">Service configuration</h4>

<h5 id="service-customization">Service customization</h5>

<p>SIP is already configured by default on FortiOS, so you don’t need to modify it. However, if you need to use specific ports for your SIP application, it is possible to change it manually.
<code class="language-plaintext highlighter-rouge">config vdom
 edit test
 config firewall service custom
 edit "SIP-custom"
 set protocol TCP/UDP/SCTP
 set udp-portrange **&lt;SIP\_custom\_port&gt;**
 set comment "custom SIP service"
 next
 end
 next
end</code>
NB: if VDOM are not used, use <code class="language-plaintext highlighter-rouge">config global</code> instead.</p>

<h5 id="session-helpers">Session-helpers</h5>

<p>Each manufacturer has its own name for this feature, Fortinet uses the words <em>session helpers</em>.
Session helpers are implemented directly by the manufacturer and may not be configurable, or limited in configurability.
For fortiOS, it is only possible to change the service port (the one the session protocol is using).</p>

<p>To display all session-helpers:
<code class="language-plaintext highlighter-rouge">config global
 show system session-helper</code>
And then look for the block with sip as name:
 <code class="language-plaintext highlighter-rouge">edit 13
 set name sip
 set port 5060
 set protocol 17
 next</code>
<strong>NB: if you need to customize or duplicate a session-helper entry, it is important not to change the name, which is how FortiOS associates the session-helper with the actual code.</strong></p>

<h5 id="policy">Policy</h5>

<p>The association between a service and its session-helpers is done automatically.</p>

<p>The last step for the basic configuration is to create the policy:
<code class="language-plaintext highlighter-rouge">config vdom
 edit test
 config firewall policy
 edit 1
 set srcintf **&lt;portX&gt;**
 set dstintf **&lt;portY&gt;**
 set srcaddr **&lt;addr\_source&gt;**
 set dstaddr **&lt;addr\_destination&gt;**
 set service SIP *//or the name of the created custom service*
 set action accept
 next
 end
 next
end</code></p>

<h4 id="application-control">Application Control</h4>

<p>If a strict Application profile is applied to your policy (which is only possible on high end devices), it may be necessary to add the RTP/RTCP or any media transport protocol used to you application control list.</p>

<h4 id="ips">IPS</h4>

<p>Similarly, you may want to monitor IPS threats regarding the media protocols and associate the IPS/Application Control profiles to the policy.</p>

<h4 id="dos-policies">Dos Policies</h4>

<p>DoS policies are better used when they are more specific: if a type of packet crosses its associated thresholds, packets will start to be dropped by the firewall.</p>

<p>With session-helpers, the media flows are identified as belonging to the same service as the SIP, and are treated as such by the DoS protection mecanisms.
Therefore it is necessary to dimension the DoS policy in a consistent way, including both SIP and RTP traffic, which may represent high udp packet rates.</p>

<p>(with G711.A codex, 1 unidirectional media stream generates about 45 pps, versus maximum 2 or 3 pps when SIP is alone)</p>

<h4 id="high-availability-parameters">High availability parameters</h4>

<p>In FortiOS, high availability and session synchronization settings for media traffic are setup as follow:
<code class="language-plaintext highlighter-rouge">config global
 config system ha
 set session-pickup enable
 set session-pickup-connectionless enable
 end
end</code></p>

<p>Sources:</p>

<ol>
  <li><a href="https://www.ietf.org/rfc/rfc3261.txt">RFC 3261: SIP: Session Initiation Protocol</a></li>
  <li><a href="http://docs.fortinet.com/">FortiOS technical documentation</a></li>
</ol>


  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ycouble/til"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/til/security/2015/04/27/dyn-firewall.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/til/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/til/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/til/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>My Today I Learned blog</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://gitlab.com/ycouble" target="_blank" title="ycouble"><svg class="svg-icon grey"><use xlink:href="/til/assets/minima-social-icons.svg#gitlab"></use></svg></a></li><li><a rel="me" href="https://github.com/ycouble" target="_blank" title="ycouble"><svg class="svg-icon grey"><use xlink:href="/til/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/jekyll" target="_blank" title="jekyll"><svg class="svg-icon grey"><use xlink:href="/til/assets/minima-social-icons.svg#linkedin"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
